FROM golang:1.22-bullseye AS base

WORKDIR /app

# pre-copy/cache go.mod for pre-downloading dependencies and only redownloading them in subsequent builds if they change
COPY go.mod . 
COPY go.sum .

RUN go mod download && go mod tidy
RUN go get github.com/TylerBrock/colorjson
RUN go get github.com/brianvoe/gofakeit
RUN go get github.com/confluentinc/confluent-kafka-go/v2/kafka
RUN go get github.com/confluentinc/confluent-kafka-go/v2/schemaregistry
RUN go get github.com/confluentinc/confluent-kafka-go/v2/schemaregistry/serde
RUN go get github.com/confluentinc/confluent-kafka-go/v2/schemaregistry/serde/avrov2
RUN go get github.com/google/uuid
RUN go get github.com/tkanos/gonfig
RUN go get go.mongodb.org/mongo-driver/bson/bsonrw
RUN go get go.mongodb.org/mongo-driver/mongo
RUN go get go.mongodb.org/mongo-driver/mongo/options
RUN go get go.mongodb.org/mongo-driver/mongo/readpref
RUN go get google.golang.org/grpc/grpclog

###########START NEW IMAGE###################
FROM base AS client

WORKDIR /app

COPY . . 

RUN go build -o . cmd/main.go

###########START NE W IMAGE###################
FROM golang:1.22-alpine AS prod

WORKDIR /app

COPY --from=client /app/main .
COPY runs.sh /app/run.sh
RUN chmod +x /app/run.sh

CMD ["run.sh"]